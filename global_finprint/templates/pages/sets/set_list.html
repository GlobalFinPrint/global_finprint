{% extends "base.html" %}
{% load leaflet_tags %}
{% load crispy_forms_tags %}
{% block content %}

    <div class="col-md-12" xmlns="http://www.w3.org/1999/html">
        <div class="row">
            <div class="well trail">
                <a href="/">Global FinPrint</a> |
                <a href="{% url 'trip_list' %}">Trips</a> |
                <a href="{% url 'trip_update' trip_pk %}">{{ trip_name }}</a> |
                Sets
            </div>
        </div>
        <div class="row">
            {% leaflet_map "set_map" callback="main_map_init" %}
            <br/>
            <br/>
        </div>
        <div class="row">
            <div class="col-md-12">
                <table class="table table-bordered table-condensed set-table" cellspacing="0" width="100%">
                    <thead>
                    <tr class="success">
                        <th id="reef">Date</th>
                        <th id="reef">Reef</th>
                        <th id="latitude">Lat</th>
                        <th id="longitude">Long</th>
                        <th id="depth">Depth</th>
                        <th id="drop_time">Drop</th>
                        <th id="collection_time">Collect</th>
                        <th id="equipment">Equipment</th>
                        <th id="visibility">Vis</th>
                        <th id="bait">Bait</th>
                        <th id="observations">View Obs</th>
                        <th class="show_observations">Show/Hide Env</th>
                        <th id="edit">Edit set</th>
                    </tr>
                    </thead>
                    {% for set in sets %}
                        <tr>
                            <td>{{ set.drop_time|date:"F d Y" }}</td>
                            <td>{{ set.reef }}</td>
                            <td>{{ set.latitude }}</td>
                            <td>{{ set.longitude }}</td>
                            <td>{{ set.depth }}</td>
                            <td>{{ set.drop_time|date:"H:i" }}</td>
                            <td>{{ set.collection_time|date:"H:i" }}</td>
                            <td>{{ set.equipment }}</td>
                            <td>{{ set.visibility }}</td>
                            <td>{{ set.bait }}</td>
                            <td>
                                <a href="{% url 'set_observation_list' set.trip.id set.id %}">
                                    View ({{ set.observation_set.count }})
                                </a>
                            </td>
                            <td>
                                <a class="show-env" href="#" data-set="{{ set.id }}">
                                    Show ({{ set.environmentmeasure_set|length }})
                                </a>
                                <a class="hide-env" href="#" data-set="{{ set.id }}">Hide</a>
                            </td>
                            <td><a href="{% url 'set_update' set.trip.id set.id %}#set-env-form">Edit</a></td>
                        </tr>
                        {# for each environmental measure: #}
                        <tr class="success env-headers set-{{ set.id }}">
                            <th></th>
                            <th class="temperature">Temp</th>
                            <th class="salinity">Salinity</th>
                            <th class="conductivity">Cond</th>
                            <th class="dissolved_oxygen">DOx</th>
                            <th class="current_flow">Flow</th>
                            <th class="current_direction">Direction</th>
                            <th class="tide_state">Tide</th>
                            <th class="estimated_wind_speed">Wind spd</th>
                            <th class="wind_direction">Wind dir</th>
                            <th class="cloud_cover">Cloud cvr</th>
                            <th class="surface_chop">Chop</th>
                            <th class="haul-drop">Drop/haul</th>
                        </tr>
                        {% if set.drop_measure %}
                        {% with env=set.drop_measure %}
                            <tr class="env-row set-{{ set.id }}">
                                <td></td>
                                <td>{{ env.water_temperature }}</td>
                                <td>{{ env.salinity }}</td>
                                <td>{{ env.conductivity }}</td>
                                <td>{{ env.dissolved_oxygen }}</td>
                                <td>{{ env.current_flow }}</td>
                                <td>{{ env.current_direction }}</td>
                                <td>{{ env.tide_state }}</td>
                                <td>{{ env.estimated_wind_speed }}</td>
                                <td>{{ env.wind_direction }}</td>
                                <td>{{ env.cloud_cover }}</td>
                                <td>{{ env.surface_chop }}</td>
                                <td>Drop measure</td>
                            </tr>
                        {% endwith %}
                        {% else %}
                            <tr class="env-row set-{{ set.id }}">
                                <td colspan="12"></td>
                                <td>Add drop measure</td>
                            </tr>
                        {% endif %}
                        {% if set.haul_measure %}
                        {% with env=set.haul_measure %}
                            <tr class="env-row set-{{ set.id }}">
                                <td></td>
                                <td>{{ env.water_temperature }}</td>
                                <td>{{ env.salinity }}</td>
                                <td>{{ env.conductivity }}</td>
                                <td>{{ env.dissolved_oxygen }}</td>
                                <td>{{ env.current_flow }}</td>
                                <td>{{ env.current_direction }}</td>
                                <td>{{ env.tide_state }}</td>
                                <td>{{ env.estimated_wind_speed }}</td>
                                <td>{{ env.wind_direction }}</td>
                                <td>{{ env.cloud_cover }}</td>
                                <td>{{ env.surface_chop }}</td>
                                <td>Haul measure</td>
                            </tr>
                        {% endwith %}
                        {% else %}
                            <tr class="env-row set-{{ set.id }}">
                                <td colspan="12"></td>
                                <td>Add haul measure</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>

        </div>
        {% if request.user.is_authenticated %}
        <h3>Add new set with environmental measures</h3>
        <div class="row">
            <div class="col-md-12">
                <div class="well clearfix">
                    <form class="form-inline set ng-pristine ng-valid" action="" method="post" id="set-env-form">
                        <div class="sub-form">
                            <h4>Set</h4>
                            {% crispy set_form %}
                            <p><!-- placeholder --></p>
                        </div>
                        <div class="sub-form">
                            <h4>Drop environmental measure</h4>
                            {% crispy drop_form %}
                            <p><!-- placeholder --></p>
                        </div>
                        <div class="sub-form">
                            <h4>Haul environmental measure</h4>
                            {% crispy haul_form %}
                            <p><!-- placeholder --></p>
                        </div>
                        <div class="form-group">
                            <input type="submit" name="save" value="Create" class="btn btn-primary" id="submit-id-save">
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <script type="text/javascript">
        function main_map_init(map, options) {
            var sets_geojson_url = '{% url "api_trip_sets_geojson" trip_pk %}';

            $.getJSON(sets_geojson_url, function (data) {
                L.geoJson(data).addTo(map);
                map.fitBounds(L.geoJson(data).getBounds().pad(20))
            });
        }
    </script>
{% endblock %}
